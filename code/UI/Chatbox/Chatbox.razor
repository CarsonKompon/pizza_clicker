@using Sandbox;
@using Sandbox.UI;
@using Sandbox.Menu;

@attribute [StyleSheet]

@namespace PizzaClicker

<root class="chatbox">
    <div @ref="ChatPanel" class="chat"></div>

    <TextEntry @ref="ChatTextEntry" CaretColor=@(Color.White) onsubmit=@SendChat onblur=@CloseChat Value:bind=@ChatText Placeholder="Enter message..." AllowEmojiReplace=@(true)></TextEntry>
</root>

@code
{
    public ILobby Lobby { get; set; }

    private Panel ChatPanel { get; set; }
    private TextEntry ChatTextEntry { get; set; }
    private string ChatText { get; set; }

    private bool IsInitialized => ChatTextEntry != null;

    protected override void OnAfterTreeRender(bool firstTime)
    {
        base.OnAfterTreeRender(firstTime);

        if (firstTime) {
            Lobby.OnChatMessage += OnChatMessage;
        }
    }

    public override void Tick()
    {
        if (!IsInitialized) {
            return;
        }

        if ((Input.Pressed("chat") || ChatTextEntry.HasActive) && !HasClass("show")) {
            ShowChat();
        } else if (!ChatTextEntry.HasFocus && HasClass("show")) {
            CloseChat();
        }
    }

    private void OnChatMessage(Friend friend, string message)
    {
        CreateChatEntry($"{friend.Name}:", message, "", friend.Id);
    }

    public void CreateChatEntry(string name, string message, string styles = "", long steamid = -1)
    {
        var entry = ChatPanel.AddChild<ChatEntry>();
        entry.SetMessage(name, message, steamid);
        entry.AddClass(styles);

        if (ChatPanel.ChildrenCount > 200) {
            ChatPanel.GetChild(ChatPanel.ChildrenCount - 1).Delete();
        }

        ChatPanel.SetChildIndex(entry, 0);

        Audio.Play("ui.button.press");
    }

    private void ShowChat()
    {
        AddClass("show");
        ChatTextEntry.Focus();
    }

    private void CloseChat()
    {
        RemoveClass("show");
        ChatTextEntry.Blur();
    }

    private void SendChat()
    {
        Lobby.SendChat(ChatText);

        ChatTextEntry.Text = "";

        CloseChat();
    }
}
