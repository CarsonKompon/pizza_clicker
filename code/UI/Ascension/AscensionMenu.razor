@using Sandbox;
@using Sandbox.UI;
@using Sandbox.UI.Construct;
@using Sandbox.Menu;
@using System;
@using System.Collections.Generic;
@using System.Linq;
@attribute [StyleSheet]

@namespace PizzaClicker

<root>
    <div class="header">
        <h1>Ascension</h1>
        <div class="info">
            <div class="panel">
                <p class="head">Ascension Level:</p>
                <p>@NumberHelper.ToStringAbbreviated(GameMenu.Instance.LocalPlayer.LegacyDough)</p>
            </div>
            <div class="panel">
                <p class="head">Heavenly Crust:</p>
                <p>@NumberHelper.ToStringAbbreviated(GameMenu.Instance.LocalPlayer.HeavenlyCrust)</p>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="tier">
            <BlessingButton Blessing=@Blessing.GetBlessing("ascension") />
        </div>
        <div class="tier">
            <BlessingButton Blessing=@Blessing.GetBlessing("research_1") />
            <BlessingButton Blessing=@Blessing.GetBlessing("pizzas_per_friend_01") />
            <BlessingButton Blessing=@Blessing.GetBlessing("starting_rolling_pins") />
            <BlessingButton Blessing=@Blessing.GetBlessing("gold_pizzas_1") />
        </div>
        <div class="tier">
            <div class="spacer" />
            <BlessingButton Blessing=@Blessing.GetBlessing("pizzas_per_second_01") />
            <BlessingButton Blessing=@Blessing.GetBlessing("building_discount_01") />
            <BlessingButton Blessing=@Blessing.GetBlessing("gold_pizzas_2") />
        </div>
    </div>
    <div @ref="AscendButton" class="ascend-button">
        <div class="bar">
            <div @ref="ProgressFill" class="bar-fill" />
        </div>
        <p>Complete Ascension</p>
    </div>
</root>


@code
{
    public Player Player { get; set; }
    Panel ProgressFill { get; set; }
    Panel AscendButton { get; set; }

    float Progress = 0f;

    public override void Tick()
    {
        ProgressFill.Style.Width = Length.Percent(Progress * 100f);
        
        if(AscendButton.HasActive)
        {
            Progress += Time.Delta / 3f;
            if(Progress >= 1f)
            {
                Progress = 0f;
                GameMenu.Instance.LocalPlayer.Ascend();
            }
        }
        else
        {
            Progress -= Time.Delta * 4f;
            if(Progress < 0f)
            {
                Progress = 0f;
            }
        }

        Random rand = new Random();
        var shake = 100f * Progress;
        AscendButton.Style.Top = Length.Pixels(rand.Float(-shake,shake));
        AscendButton.Style.Left = Length.Pixels(rand.Float(-shake,shake));
    }

    protected override int BuildHash()
    {
        return HashCode.Combine(Player?.TotalPizzasBaked);
    }
}